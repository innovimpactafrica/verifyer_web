import { Component, HostListener, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { ClientSidebarComponent } from '../../client-sidebar/client-sidebar.component';
import { DomSanitizer, SafeHtml } from '@angular/platform-browser';
import { DemandesService, Demande } from '../../../../services/demandes.service';

// Interfaces
interface StatCard {
    title: string;
    value: string;
    bgColor: string;
    iconSvg: string;
}

@Component({
    selector: 'app-mes-demandes',
    standalone: true,
    imports: [CommonModule, RouterModule, ClientSidebarComponent],
    templateUrl: './mes-demandes.component.html',
    styleUrl: './mes-demandes.component.css'
})
export class MesDemandesComponent implements OnInit {

    constructor(
        private sanitizer: DomSanitizer,
        private demandesService: DemandesService
    ) { }

    ngOnInit() {
        // S'abonner aux changements de demandes
        this.demandesService.getDemandes().subscribe((demandes: Demande[]) => {
            this.demandes = demandes;
            this.updateStats();
        });
    }

    // Mettre à jour les statistiques en fonction des demandes
    updateStats() {
        const soumis = this.demandes.filter(d => d.status === 'Soumis').length;
        const enCours = this.demandes.filter(d => d.status === 'En cours').length;
        const valides = this.demandes.filter(d => d.status === 'Validée').length;
        const rejetes = this.demandes.filter(d => d.status === 'Rejetée').length;

        this.statsCards[0].value = String(soumis).padStart(2, '0');
        this.statsCards[1].value = String(enCours).padStart(2, '0');
        this.statsCards[2].value = String(valides).padStart(2, '0');
        this.statsCards[3].value = String(rejetes).padStart(2, '0');
    }

    // View mode: 'list' or 'grid'
    viewMode: 'list' | 'grid' = 'list';

    // Filter by status
    selectedStatus: string = 'Tous les status';
    showStatusDropdown: boolean = false;
    statusOptions: string[] = ['Tous les status', 'Soumis', 'En cours', 'Validée', 'Rejetée'];

    // Toggle view mode
    setViewMode(mode: 'list' | 'grid'): void {
        this.viewMode = mode;
    }

    // Toggle status dropdown
    toggleStatusDropdown(): void {
        this.showStatusDropdown = !this.showStatusDropdown;
    }

    // Select status filter
    selectStatus(status: string): void {
        this.selectedStatus = status;
        this.showStatusDropdown = false;
    }

    // Get filtered demandes based on selected status
    get filteredDemandes(): Demande[] {
        if (this.selectedStatus === 'Tous les status') {
            return this.demandes;
        }
        return this.demandes.filter(demande => demande.status === this.selectedStatus);
    }

    // Statistics Cards Data
    public statsCards: StatCard[] = [
        {
            title: 'Soumis',
            value: '04',
            bgColor: 'bg-[#274B9B]',
            iconSvg: `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.97991 1C4.90497 1.00011 4.83101 1.01706 4.7635 1.0496C4.696 1.08214 4.63667 1.12944 4.58991 1.188L1.53991 5H5.99991C6.13252 5 6.25969 5.05268 6.35346 5.14645C6.44723 5.24021 6.49991 5.36739 6.49991 5.5C6.49991 5.89782 6.65794 6.27936 6.93925 6.56066C7.22055 6.84196 7.60208 7 7.99991 7C8.39773 7 8.77926 6.84196 9.06057 6.56066C9.34187 6.27936 9.49991 5.89782 9.49991 5.5C9.49991 5.36739 9.55259 5.24021 9.64635 5.14645C9.74012 5.05268 9.8673 5 9.99991 5H14.4599L11.4099 1.188C11.3631 1.12944 11.3038 1.08214 11.2363 1.0496C11.1688 1.01706 11.0948 1.00011 11.0199 1H4.97991ZM14.9339 6H10.4499C10.3351 6.56514 10.0285 7.07324 9.58204 7.43819C9.13553 7.80314 8.57659 8.00251 7.99991 8.00251C7.42323 8.00251 6.86428 7.80314 6.41778 7.43819C5.97127 7.07324 5.66467 6.56514 5.54991 6H1.06591L1.38591 8.562C1.40106 8.68325 1.46008 8.79475 1.55184 8.87545C1.64359 8.95615 1.76172 9.00045 1.88391 9H14.1179C14.2398 8.99997 14.3574 8.95544 14.4487 8.87479C14.5401 8.79413 14.5988 8.68291 14.6139 8.562L14.9339 6ZM3.80891 0.563C3.94951 0.38724 4.12785 0.245373 4.33074 0.147914C4.53362 0.050454 4.75583 -9.92793e-05 4.98091 1.46375e-07H11.0189C11.244 -9.92793e-05 11.4662 0.050454 11.6691 0.147914C11.872 0.245373 12.0503 0.38724 12.1909 0.563L15.8909 5.188C15.9325 5.24018 15.9632 5.30015 15.9812 5.36439C15.9992 5.42862 16.0042 5.49581 15.9959 5.562L15.6059 8.686C15.5606 9.04889 15.3842 9.38271 15.11 9.62469C14.8358 9.86667 14.4826 10.0001 14.1169 10H1.88291C1.5172 10.0001 1.16403 9.86667 0.889823 9.62469C0.615615 9.38271 0.439256 9.04889 0.393907 8.686L0.00390735 5.562C-0.00428891 5.49574 0.000867769 5.42851 0.0190732 5.36428C0.0372786 5.30004 0.068164 5.24011 0.109907 5.188L3.80891 0.563ZM0.124907 11.17C0.171762 11.1167 0.229438 11.0739 0.294097 11.0446C0.358755 11.0153 0.428915 11.0001 0.499907 11H5.99991C6.13252 11 6.25969 11.0527 6.35346 11.1464C6.44723 11.2402 6.49991 11.3674 6.49991 11.5C6.49991 11.8978 6.65794 12.2794 6.93925 12.5607C7.22055 12.842 7.60208 13 7.99991 13C8.39773 13 8.77926 12.842 9.06057 12.5607C9.34187 12.2794 9.49991 11.8978 9.49991 11.5C9.49991 11.3674 9.55259 11.2402 9.64635 11.1464C9.74012 11.0527 9.8673 11 9.99991 11H15.4999C15.5708 11 15.6409 11.0151 15.7055 11.0443C15.7701 11.0734 15.8277 11.116 15.8746 11.1691C15.9216 11.2223 15.9566 11.2848 15.9775 11.3525C15.9984 11.4203 16.0047 11.4917 15.9959 11.562L15.6059 14.686C15.5606 15.0489 15.3842 15.3827 15.11 15.6247C14.8358 15.8667 14.4826 16.0001 14.1169 16H1.88291C1.5172 16.0001 1.16403 15.8667 0.889823 15.6247C0.615615 15.3827 0.439256 15.0489 0.393907 14.686L0.00390735 11.562C-0.00493837 11.4917 0.00127556 11.4202 0.0221368 11.3525C0.0429981 11.2847 0.0780298 11.2222 0.124907 11.169V11.17ZM1.06591 12L1.38591 14.562C1.40104 14.6831 1.45992 14.7944 1.55146 14.8751C1.64301 14.9558 1.76089 15.0002 1.88291 15H14.1169C14.2388 15 14.3564 14.9554 14.4477 14.8748C14.5391 14.7941 14.5978 14.6829 14.6129 14.562L14.9329 12H10.4499C10.3351 12.5651 10.0285 13.0732 9.58204 13.4382C9.13553 13.8031 8.57659 14.0025 7.99991 14.0025C7.42323 14.0025 6.86428 13.8031 6.41778 13.4382C5.97127 13.0732 5.66467 12.5651 5.54991 12H1.06591Z" fill="white" /></svg>`
        },
        {
            title: 'En attente',
            value: '02',
            bgColor: 'bg-[#D6AB17]',
            iconSvg: `<svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 1.5C18 2.32812 17.8828 3.13281 17.6484 3.91406C17.4141 4.69531 17.0586 5.43359 16.582 6.12891C16.3398 6.48047 16.0859 6.80078 15.8203 7.08984C15.5547 7.37891 15.2734 7.64062 14.9766 7.875C14.6797 8.10938 14.3594 8.33203 14.0156 8.54297C13.6719 8.75391 13.3125 8.94531 12.9375 9.11719C12.6484 9.25 12.4219 9.42969 12.2578 9.65625C12.0938 9.88281 12.0078 10.1641 12 10.5C12 10.8281 12.082 11.1055 12.2461 11.332C12.4102 11.5586 12.6406 11.7422 12.9375 11.8828C13.3203 12.0625 13.6797 12.2539 14.0156 12.457C14.3516 12.6602 14.668 12.8789 14.9648 13.1133C15.2617 13.3477 15.5469 13.6133 15.8203 13.9102C16.0938 14.207 16.3477 14.5273 16.582 14.8711C17.0508 15.5586 17.4023 16.293 17.6367 17.0742C17.8711 17.8555 17.9922 18.6641 18 19.5H19.5V21H0V19.5H1.5C1.5 18.6719 1.61719 17.8672 1.85156 17.0859C2.08594 16.3047 2.44141 15.5664 2.91797 14.8711C3.16797 14.5039 3.42578 14.1797 3.69141 13.8984C3.95703 13.6172 4.23438 13.3555 4.52344 13.1133C4.8125 12.8711 5.12891 12.6562 5.47266 12.4688C5.81641 12.2812 6.17969 12.0898 6.5625 11.8945C6.84375 11.7617 7.07031 11.5781 7.24219 11.3438C7.41406 11.1094 7.5 10.8281 7.5 10.5C7.5 10.1719 7.41797 9.89453 7.25391 9.66797C7.08984 9.44141 6.85938 9.25781 6.5625 9.11719C6.17969 8.9375 5.82031 8.74609 5.48438 8.54297C5.14844 8.33984 4.83203 8.12109 4.53516 7.88672C4.23828 7.65234 3.95312 7.38672 3.67969 7.08984C3.40625 6.79297 3.15234 6.47266 2.91797 6.12891C2.44922 5.44141 2.09766 4.70703 1.86328 3.92578C1.62891 3.14453 1.50781 2.33594 1.5 1.5H0V0H19.5V1.5H18ZM10.5 10.5C10.5 9.85938 10.668 9.30469 11.0039 8.83594C11.3398 8.36719 11.7891 7.99609 12.3516 7.72266C12.5781 7.61328 12.7969 7.50781 13.0078 7.40625C13.2188 7.30469 13.4258 7.17578 13.6289 7.01953C14.082 6.70703 14.4844 6.34766 14.8359 5.94141C15.1875 5.53516 15.4883 5.09375 15.7383 4.61719C15.9883 4.14062 16.1758 3.64062 16.3008 3.11719C16.4258 2.59375 16.4922 2.05469 16.5 1.5H3C3 2.04688 3.0625 2.58203 3.1875 3.10547C3.3125 3.62891 3.5 4.12891 3.75 4.60547C4 5.08203 4.30078 5.52344 4.65234 5.92969C5.00391 6.33594 5.41016 6.69922 5.87109 7.01953C6.07422 7.16797 6.28125 7.29297 6.49219 7.39453C6.70312 7.49609 6.92188 7.60547 7.14844 7.72266C7.71094 7.99609 8.16016 8.36719 8.49609 8.83594C8.83203 9.30469 9 9.85938 9 10.5C9 11.1406 8.83203 11.6953 8.49609 12.1641C8.16016 12.6328 7.71094 13.0039 7.14844 13.2773C6.92188 13.3867 6.70312 13.4922 6.49219 13.5938C6.28125 13.6953 6.07422 13.8242 5.87109 13.9805C5.41797 14.293 5.01562 14.6523 4.66406 15.0586C4.3125 15.4648 4.01172 15.9062 3.76172 16.3828C3.51172 16.8594 3.32422 17.3594 3.19922 17.8828C3.07422 18.4062 3.00781 18.9453 3 19.5H16.5C16.5 18.9531 16.4375 18.418 16.3125 17.8945C16.1875 17.3711 16 16.8711 15.75 16.3945C15.5 15.918 15.1992 15.4766 14.8477 15.0703C14.4961 14.6641 14.0898 14.3008 13.6289 13.9805C13.4258 13.832 13.2188 13.707 13.0078 13.6055C12.7969 13.5039 12.5781 13.3945 12.3516 13.2773C11.7891 13.0039 11.3398 12.6328 11.0039 12.1641C10.668 11.6953 10.5 11.1406 10.5 10.5Z" fill="white" /></svg>`
        },
        {
            title: 'Validés',
            value: '01',
            bgColor: 'bg-[#0D823B]',
            iconSvg: `<svg width="16" height="12" viewBox="0 0 16 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.28846 8.775L13.7635 0.3C13.9635 0.1 14.1968 0 14.4635 0C14.7301 0 14.9635 0.1 15.1635 0.3C15.3635 0.5 15.4635 0.737667 15.4635 1.013C15.4635 1.28833 15.3635 1.52567 15.1635 1.725L5.98846 10.925C5.78846 11.125 5.55513 11.225 5.28846 11.225C5.02179 11.225 4.78846 11.125 4.58846 10.925L0.288462 6.625C0.0884617 6.425 -0.00753846 6.18767 0.000461538 5.913C0.00846154 5.63833 0.112795 5.40067 0.313461 5.2C0.514128 4.99933 0.751795 4.89933 1.02646 4.9C1.30113 4.90067 1.53846 5.00067 1.73846 5.2L5.28846 8.775Z" fill="white" /></svg>`
        },
        {
            title: 'Rejetés',
            value: '8',
            bgColor: 'bg-[#F54351]',
            iconSvg: `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.75 6.75L6.75 12.75M6.75 6.75L12.75 12.75M5.555 1.219C5.91 0.865 6.201 0.75 6.687 0.75H12.813C13.299 0.75 13.591 0.865 13.945 1.219L18.281 5.555C18.635 5.909 18.75 6.201 18.75 6.687V12.813C18.75 13.313 18.625 13.601 18.281 13.945L13.945 18.281C13.591 18.635 13.299 18.75 12.813 18.75H6.687C6.187 18.75 5.899 18.625 5.555 18.281L1.22 13.945C0.865 13.59 0.75 13.299 0.75 12.813V6.687C0.75 6.187 0.875 5.899 1.219 5.555L5.555 1.219Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></svg>`
        }
    ];

    // Demandes Data - chargées depuis le service
    public demandes: Demande[] = [];

    // Close dropdown when clicking outside
    @HostListener('document:click', ['$event'])
    onDocumentClick(event: MouseEvent): void {
        const target = event.target as HTMLElement;
        if (!target.closest('.relative')) {
            this.showStatusDropdown = false;
        }
    }

    // Utility Methods
    getSafeHtml(html: string): SafeHtml {
        return this.sanitizer.bypassSecurityTrustHtml(html);
    }
}
