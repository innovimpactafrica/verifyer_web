import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { DomSanitizer, SafeHtml } from '@angular/platform-browser';
import { ClientSidebarComponent } from '../../client-sidebar/client-sidebar.component';

interface StatCard {
    title: string;
    value: string;
    trend: string;
    trendColor: string;
    bgColor: string;
    iconSvg: string;
    trendIconSvg: string;
}

interface ActionIcon {
    name: string;
    svgContent: string;
    colorClass: string;
    hoverClass: string;
}

interface PaymentMethod {
    id: 'carte' | 'mobile';
    label: string;
    svgContent: string;
}

@Component({
    selector: 'app-mes-certifications',
    standalone: true,
    imports: [CommonModule, RouterModule, ClientSidebarComponent],
    templateUrl: './mes-certifications.component.html',
    styleUrl: './mes-certifications.component.css'
})
export class MesCertificationsComponent implements OnInit {
    certifications: any[] = [];
    showQRModal: boolean = false;
    selectedCertification: any = null;
    // Renouvellement modal state
    showRenewModal: boolean = false;
    selectedForRenewal: any = null;
    selectedPaymentMethod: 'carte' | 'mobile' = 'carte';

    // SVG Icons for certification types
    typeIcons: { [key: string]: string } = {
        'Immobilier': `<svg width="22" height="21" viewBox="0 0 22 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.75 19.7501H0.750031M0.750031 8.7501L8.87603 2.2501C9.40796 1.82459 10.0689 1.59277 10.75 1.59277C11.4312 1.59277 12.0921 1.82459 12.624 2.2501L20.75 8.7501" stroke="#0D823B" stroke-width="1.5" stroke-linecap="round"/><path opacity="0.5" d="M14.25 3.25V1.25C14.25 1.11739 14.3027 0.990215 14.3965 0.896447C14.4902 0.802679 14.6174 0.75 14.75 0.75H17.25C17.3826 0.75 17.5098 0.802679 17.6036 0.896447C17.6974 0.990215 17.75 1.11739 17.75 1.25V6.25" stroke="#0D823B" stroke-width="1.5" stroke-linecap="round"/><path d="M2.75003 19.75V7.25M18.75 19.75V7.25" stroke="#0D823B" stroke-width="1.5" stroke-linecap="round"/><path opacity="0.5" d="M13.75 19.75V14.75C13.75 13.336 13.75 12.629 13.31 12.19C12.872 11.75 12.165 11.75 10.75 11.75C9.33503 11.75 8.62903 11.75 8.19003 12.19C7.75003 12.628 7.75003 13.335 7.75003 14.75V19.75M12.75 7.25C12.75 7.78043 12.5393 8.28914 12.1642 8.66421C11.7892 9.03929 11.2805 9.25 10.75 9.25C10.2196 9.25 9.71089 9.03929 9.33582 8.66421C8.96074 8.28914 8.75003 7.78043 8.75003 7.25C8.75003 6.71957 8.96074 6.21086 9.33582 5.83579C9.71089 5.46071 10.2196 5.25 10.75 5.25C11.2805 5.25 11.7892 5.46071 12.1642 5.83579C12.5393 6.21086 12.75 6.71957 12.75 7.25Z" stroke="#0D823B" stroke-width="1.5"/></svg>`,
        'Restaurant': `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_93_4230)"><path d="M1.79655 1.49194L13.31 13.0054C13.5285 13.2239 13.6512 13.5202 13.6512 13.8291C13.6512 14.1381 13.5285 14.4344 13.31 14.6529C13.0915 14.8713 12.7952 14.9939 12.4862 14.9939C12.1773 14.9939 11.881 14.8713 11.6625 14.6529L8.84999 11.7919C8.66594 11.605 8.56268 11.3533 8.56249 11.091V10.9182C8.56252 10.7857 8.53623 10.6546 8.48516 10.5324C8.43409 10.4102 8.35925 10.2994 8.26499 10.2063L7.90187 9.87101C7.7786 9.75726 7.62869 9.67635 7.46596 9.63572C7.30323 9.59509 7.13288 9.59605 6.97062 9.63851C6.71473 9.70529 6.44583 9.704 6.1906 9.63476C5.93537 9.56553 5.70268 9.43076 5.51562 9.24382L2.84593 6.57382C1.26218 4.99007 0.679367 2.59851 1.79655 1.49194Z" stroke="#6F42C1" stroke-linejoin="round"/><path d="M12.5 1L10.0859 3.41406C9.90018 3.59979 9.75282 3.82029 9.65229 4.06297C9.55175 4.30565 9.50001 4.56576 9.50001 4.82844V5.29281C9.50002 5.35851 9.48708 5.42357 9.46193 5.48427C9.43678 5.54497 9.39992 5.60012 9.35345 5.64656L9.00001 6M10 7L10.3534 6.64656C10.3999 6.60009 10.455 6.56322 10.5157 6.53808C10.5764 6.51293 10.6415 6.49999 10.7072 6.5H11.1716C11.4343 6.5 11.6944 6.44826 11.937 6.34772C12.1797 6.24718 12.4002 6.09983 12.5859 5.91406L15 3.5M13.75 2.25L11.25 4.75M6.25001 11.5L3.13376 14.6337C2.89935 14.8681 2.58146 14.9997 2.25001 14.9997C1.91855 14.9997 1.60067 14.8681 1.36626 14.6337C1.13192 14.3993 1.00027 14.0815 1.00027 13.75C1.00027 13.4185 1.13192 13.1007 1.36626 12.8663L4.00001 10.25" stroke="#6F42C1" stroke-linecap="round" stroke-linejoin="round"/></g><defs><clipPath id="clip0_93_4230"><rect width="16" height="16" fill="white"/></clipPath></defs></svg>`,
        'Hôtel': `<svg width="22" height="15" viewBox="0 0 22 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 15V0H2V10H10V2H18C19.1 2 20.0417 2.39167 20.825 3.175C21.6083 3.95833 22 4.9 22 6V15H20V12H2V15H0ZM6 9C5.16667 9 4.45833 8.70833 3.875 8.125C3.29167 7.54167 3 6.83333 3 6C3 5.16667 3.29167 4.45833 3.875 3.875C4.45833 3.29167 5.16667 3 6 3C6.83333 3 7.54167 3.29167 8.125 3.875C8.70833 4.45833 9 5.16667 9 6C9 6.83333 8.70833 7.54167 8.125 8.125C7.54167 8.70833 6.83333 9 6 9ZM12 10H20V6C20 5.45 19.8043 4.97933 19.413 4.588C19.0217 4.19667 18.5507 4.00067 18 4H12V10ZM6 7C6.28333 7 6.521 6.904 6.713 6.712C6.905 6.52 7.00067 6.28267 7 6C6.99933 5.71733 6.90333 5.48 6.712 5.288C6.52067 5.096 6.28333 5 6 5C5.71667 5 5.47933 5.096 5.288 5.288C5.09667 5.48 5.00067 5.71733 5 6C4.99933 6.28267 5.09533 6.52033 5.288 6.713C5.48067 6.90567 5.718 7.00133 6 7Z" fill="#FD7E14"/></svg>`,
        'Artisan': `<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.737625 8.57304e-05C0.725082 -0.000103941 0.712537 2.11305e-05 0.7 0.000460763C0.5535 0.00536701 0.452687 0.0546482 0.383969 0.123367C0.292344 0.214992 0.235219 0.363648 0.271844 0.601648C0.308531 0.839648 0.449438 1.15646 0.749094 1.50605C2.87078 3.98137 4.90331 6.3673 6.48981 8.13012C6.87334 8.55624 7.23022 8.94509 7.55622 9.29056C7.93419 8.29362 8.63653 7.59855 9.52191 7.26821C9.18362 6.94949 8.80516 6.60218 8.39075 6.22921C6.628 4.64271 4.242 2.61012 1.76672 0.488429C1.41716 0.188742 1.10031 0.047867 0.862313 0.0111795C0.821044 0.00470782 0.779388 0.00100159 0.737625 8.57304e-05ZM12.4598 0.0326795C12.4502 0.0325754 12.441 0.0328149 12.4324 0.0333982C12.3633 0.037992 12.3281 0.0538358 12.2894 0.092492L11.4276 0.954367L13.1512 2.67793L14.013 1.81605C14.0517 1.77743 14.0675 1.74224 14.0721 1.67312C14.0768 1.60405 14.0605 1.5033 14.0157 1.38674C13.926 1.15362 13.7258 0.865898 13.4827 0.622836C13.2397 0.379773 12.9519 0.179555 12.7188 0.089867C12.6168 0.0506483 12.527 0.0333045 12.4598 0.0326795H12.4598ZM11.0298 1.35205L10.7205 1.66146L11.0298 1.97077L11.4276 2.36855L11.7369 2.67787L12.1347 3.07565L12.444 3.38502L12.7534 3.07565L11.0298 1.35205ZM10.3228 2.05918L7.59184 4.79012L7.91894 5.08174L10.6321 2.36855L10.3228 2.05918ZM11.0298 2.76634L8.33947 5.45665L8.66662 5.74824L11.3392 3.07565L11.0298 2.76634ZM11.737 3.47334L9.08716 6.12318L9.41431 6.4148L12.0464 3.78274L11.7371 3.47337H11.737V3.47334ZM5.05397 7.32802L1.30719 11.0749L1.6165 11.3842L5.34594 7.65474L5.05397 7.32802ZM9.98084 7.70762C9.02894 7.94596 8.31709 8.61962 7.99309 9.74568C8.16972 9.92646 8.33547 10.0921 8.48622 10.2365C8.72309 10.4635 8.92672 10.643 9.08653 10.7664C9.14206 10.2281 9.40044 9.73324 9.76294 9.36984C10.0942 9.03771 10.5284 8.80715 10.9856 8.77321C10.8647 8.62209 10.7 8.43727 10.4972 8.22562C10.346 8.0679 10.1717 7.89365 9.98084 7.70762ZM5.72137 8.07474L2.01422 11.7818L2.32359 12.0913L6.01344 8.40146L5.72137 8.07474ZM6.38891 8.82143L2.72137 12.489L3.03063 12.7983L6.68094 9.14815L6.38891 8.82143ZM11.0856 9.33102C10.7607 9.3353 10.4315 9.49602 10.1611 9.76712C9.80059 10.1285 9.57756 10.6687 9.65278 11.1953C9.81947 12.3622 10.395 13.2518 11.1984 13.7339C11.9087 14.16 12.8063 14.2761 13.8123 13.9521C13.0553 13.8268 12.3599 12.9926 12.3061 12.3693C12.6383 12.7698 13.0542 13.1364 13.5069 13.3615C13.1981 12.656 13.2194 11.9411 13.1604 11.3515C13.1182 10.9289 13.0388 10.5708 12.8049 10.2526C12.5709 9.93452 12.1667 9.6339 11.4067 9.38059C11.3032 9.3461 11.1947 9.32934 11.0856 9.33102ZM1.01213 11.5753L1.01203 11.5753L1.01209 11.5754L1.01213 11.5753ZM1.01209 11.5754L0.633438 12.5223L1.58319 13.4721L2.53022 13.0934L2.32366 12.8867L1.92578 12.489L1.61647 12.1797L1.21866 11.782L1.01209 11.5754ZM0.406 13.0906L0 14.1054L1.01494 13.6994L0.406 13.0906Z" fill="#274B9B"/></svg>`
    };

    // Action buttons SVG icons
    actionIcons: { [key: string]: ActionIcon } = {
        'eye': {
            name: 'Voir',
            svgContent: `<svg width="15" height="10" viewBox="0 0 15 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.322 1.33127C8.54593 1.3272 9.74616 1.66861 10.7847 2.31623C11.8233 2.96386 12.658 3.89142 13.1929 4.99227C12.0946 7.23547 9.85142 8.65327 7.322 8.65327C4.79258 8.65327 2.54939 7.23547 1.45109 4.99227C1.986 3.89142 2.82072 2.96386 3.85928 2.31623C4.89784 1.66861 6.09807 1.3272 7.322 1.33127ZM7.322 0C3.99382 0 1.15155 2.07013 0 4.99227C1.15155 7.91442 3.99382 9.98455 7.322 9.98455C10.6502 9.98455 13.4924 7.91442 14.644 4.99227C13.4924 2.07013 10.6502 0 7.322 0ZM7.322 3.32818C7.76334 3.32818 8.18661 3.50351 8.49869 3.81558C8.81077 4.12766 8.98609 4.55093 8.98609 4.99227C8.98609 5.43362 8.81077 5.85689 8.49869 6.16896C8.18661 6.48104 7.76334 6.65636 7.322 6.65636C6.88066 6.65636 6.45739 6.48104 6.14531 6.16896C5.83323 5.85689 5.65791 5.43362 5.65791 4.99227C5.65791 4.55093 5.83323 4.12766 6.14531 3.81558C6.45739 3.50351 6.88066 3.32818 7.322 3.32818ZM7.322 1.99691C5.67122 1.99691 4.32664 3.3415 4.32664 4.99227C4.32664 6.64305 5.67122 7.98764 7.322 7.98764C8.97278 7.98764 10.3174 6.64305 10.3174 4.99227C10.3174 3.3415 8.97278 1.99691 7.322 1.99691Z" fill="#4B4848"/></svg>`,
            colorClass: 'text-[#0D823B]',
            hoverClass: 'hover:text-[#0A6B2F]'
        },
        'qr': {
            name: 'QR Code',
            svgContent: `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.5 0V7H15.5V0H8.5ZM14 5.5H10V1.5H14V5.5ZM0 7H7V0H0V7ZM1.5 1.5H5.5V5.5H1.5V1.5ZM0 15.5H7V8.5H0V15.5ZM1.5 10H5.5V14H1.5V10ZM8.5 8.5H10.25V10.25H8.5V8.5ZM12 8.5H13.75V10.25H12V8.5ZM10.25 10.25H12V12H10.25V10.25ZM13.75 10.25H15.5V12H13.75V10.25ZM8.5 12H10.25V13.75H8.5V12ZM12 12H13.75V13.75H12V12ZM10.25 13.75H12V15.5H10.25V13.75ZM13.75 13.75H15.5V15.5H13.75V13.75Z" fill="#274B9B"/></svg>`,
            colorClass: 'text-[#0D823B]',
            hoverClass: 'hover:text-[#0A6B2F]'
        },
        'download': {
            name: 'Télécharger',
            svgContent: `<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10.577L3.461 7.039L4.169 6.319L6.5 8.65V0H7.5V8.65L9.83 6.32L10.539 7.039L7 10.577ZM1.616 14C1.15533 14 0.771 13.846 0.463 13.538C0.155 13.23 0.000666667 12.8453 0 12.384V9.961H1V12.384C1 12.538 1.064 12.6793 1.192 12.808C1.32 12.9367 1.461 13.0007 1.615 13H12.385C12.5383 13 12.6793 12.936 12.808 12.808C12.9367 12.68 13.0007 12.5387 13 12.384V9.961H14V12.384C14 12.8447 13.846 13.229 13.538 13.537C13.23 13.845 12.8453 13.9993 12.384 14H1.616Z" fill="#0D823B"/></svg>`,
            colorClass: 'text-[#0D823B]',
            hoverClass: 'hover:text-[#0A6B2F]'
        },
        'refresh': {
            name: 'Renouveler',
            svgContent: `<svg width="19" height="16" viewBox="0 0 19 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.833252 8.33325C0.833252 5.56242 3.08159 3.33325 5.83325 3.33325H17.4999" stroke="#D6AB17" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.9999 0.833252L17.4999 3.33325L14.9999 5.83325M17.4999 7.49992C17.4999 10.2708 15.2516 12.4999 12.4999 12.4999H0.833252" stroke="#D6AB17" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/><path d="M3.33325 14.9998L0.833252 12.4998L3.33325 9.99976" stroke="#D6AB17" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            colorClass: 'text-[#D6AB17]',
            hoverClass: 'hover:text-[#B89214]'
        }
    };

    // Payment methods data
    paymentMethods: PaymentMethod[] = [
        {
            id: 'carte',
            label: 'Carte bancaire',
            svgContent: `<svg width="22" height="18" viewBox="0 0 22 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.75 8.75C0.75 4.979 0.75 3.093 1.922 1.922C3.094 0.751 4.979 0.75 8.75 0.75H12.75C16.521 0.75 18.407 0.75 19.578 1.922C20.749 3.094 20.75 4.979 20.75 8.75C20.75 12.521 20.75 14.407 19.578 15.578C18.406 16.749 16.521 16.75 12.75 16.75H8.75C4.979 16.75 3.093 16.75 1.922 15.578C0.751 14.406 0.75 12.521 0.75 8.75Z" stroke="#0D823B" stroke-width="1.5"/><path opacity="0.5" d="M8.75 12.75H4.75M12.75 12.75H11.25M0.75 6.75H20.75" stroke="#0D823B" stroke-width="1.5" stroke-linecap="round"/></svg>`
        },
        {
            id: 'mobile',
            label: 'Mobile Money',
            svgContent: `<svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.0003 0H2.11795C0.948835 0 0.000305176 0.948529 0.000305176 2.11765V20.4706C0.000305176 21.6397 0.948835 22.5882 2.11795 22.5882H12.0003C13.1694 22.5882 14.118 21.6397 14.118 20.4706V2.11765C14.118 0.948529 13.1694 0 12.0003 0ZM7.05913 21.1765C6.27825 21.1765 5.64736 20.5456 5.64736 19.7647C5.64736 18.9838 6.27825 18.3529 7.05913 18.3529C7.84001 18.3529 8.47089 18.9838 8.47089 19.7647C8.47089 20.5456 7.84001 21.1765 7.05913 21.1765ZM12.0003 16.4118C12.0003 16.7029 11.7621 16.9412 11.4709 16.9412H2.64736C2.35619 16.9412 2.11795 16.7029 2.11795 16.4118V2.64706C2.11795 2.35588 2.35619 2.11765 2.64736 2.11765H11.4709C11.7621 2.11765 12.0003 2.35588 12.0003 2.64706V16.4118Z" fill="#231F20"/><rect x="11.177" y="3.53027" width="4.11765" height="12.9412" fill="white"/><g clip-path="url(#clip0_96_4875)"><path d="M15.2947 9.70654C14.7487 9.70654 14.225 9.92345 13.8389 10.3096C13.4528 10.6957 13.2359 11.2193 13.2359 11.7654C13.2359 12.3114 13.4528 12.8351 13.8389 13.2212C14.225 13.6073 14.7487 13.8242 15.2947 13.8242C15.8408 13.8242 16.3644 13.6073 16.7505 13.2212C17.1366 12.8351 17.3535 12.3114 17.3535 11.7654C17.3535 11.2193 17.1366 10.6957 16.7505 10.3096C16.3644 9.92345 15.8408 9.70654 15.2947 9.70654ZM14.4124 11.7654C14.4124 11.5314 14.5053 11.3069 14.6708 11.1414C14.8363 10.976 15.0607 10.883 15.2947 10.883C15.5287 10.883 15.7532 10.976 15.9186 11.1414C16.0841 11.3069 16.1771 11.5314 16.1771 11.7654C16.1771 11.9994 16.0841 12.2238 15.9186 12.3893C15.7532 12.5548 15.5287 12.6477 15.2947 12.6477C15.0607 12.6477 14.8363 12.5548 14.6708 12.3893C14.5053 12.2238 14.4124 11.9994 14.4124 11.7654Z" fill="#231F20"/><path d="M18.3055 5.53467L18.4325 5.7124L18.6395 5.64209L19.5956 5.31592L20.6268 8.33154L20.6952 8.53076H21.1766V15.0015H9.41199V8.53076H9.71179V8.52783L9.79578 8.52881L9.90125 8.52979L9.98328 8.46436L16.6151 3.16455L18.3055 5.53467Z" fill="#231F20"/></g><defs><clipPath id="clip0_96_4875"><rect width="12.3529" height="12.3529" fill="white" transform="translate(8.82349 3.52979)"/></clipPath></defs></svg>`
        }
    ];

    statsCards: StatCard[] = [
        {
            title: 'Certificats Valides',
            value: '8',
            trend: '+2 nouveaux ce mois',
            trendColor: 'text-[#0D823B]',
            bgColor: 'bg-[#4CD17E]',
            iconSvg: `<svg width="17" height="21" viewBox="0 0 17 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.632 3.9L2.28 6.66L1.632 9.408L4.044 10.896L5.52 13.308L8.28 12.66L11.04 13.308L12.516 10.896L14.928 9.408L14.28 6.66L14.928 3.9L12.528 2.412L11.04 0L8.28 0.66L5.532 0.012L4.032 2.412L1.632 3.9ZM8.292 11.508C7.01896 11.508 5.79806 11.0023 4.89789 10.1021C3.99771 9.20194 3.492 7.98104 3.492 6.708C3.492 5.43496 3.99771 4.21406 4.89789 3.31389C5.79806 2.41371 7.01896 1.908 8.292 1.908C10.932 1.908 13.08 4.056 13.08 6.696C13.08 9.36 10.932 11.508 8.292 11.508ZM8.268 10.308C6.276 10.308 4.68 8.7 4.68 6.708C4.68 4.728 6.276 3.108 8.268 3.108C10.26 3.108 11.88 4.728 11.88 6.708C11.88 8.7 10.26 10.308 8.268 10.308ZM12.876 11.628L11.34 14.316L8.844 13.752L11.88 20.748L13.56 18.108H16.56L12.876 11.628ZM3.636 11.712L5.136 14.412L7.692 13.8L4.68 20.748L3 18.108H0L3.636 11.712Z" fill="white"/></svg>`,
            trendIconSvg: `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.77102 0.8375C2.6504 0.95812 2.57651 1.12574 2.57675 1.30983L2.57675 1.39085C2.57675 1.75949 2.87518 2.05791 3.24335 2.05744L6.88568 2.05744L0.724278 8.21885C0.464063 8.47906 0.464063 8.90144 0.724278 9.16166C0.984494 9.42187 1.40687 9.42187 1.66709 9.16166L7.82849 3.00025V6.64259C7.82849 7.01123 8.12692 7.30966 8.49509 7.30918L8.57611 7.30918C8.94475 7.30918 9.24318 7.01076 9.24271 6.64259L9.2427 1.30983C9.2427 0.941187 8.94428 0.642759 8.57611 0.64323L3.24335 0.64323C3.05903 0.64323 2.89164 0.716879 2.77102 0.8375Z" fill="#0D823B"/></svg>`
        },
        {
            title: 'En renouvellement',
            value: '02',
            trend: '2 terminées cette semaine',
            trendColor: 'text-red-500',
            bgColor: 'bg-[#D6AB17]',
            iconSvg: `<svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.864408 15.75C0.703991 15.75 0.558158 15.71 0.426907 15.6301C0.295657 15.5502 0.193574 15.4443 0.120658 15.3125C0.0477409 15.1807 0.00778261 15.0383 0.000782609 14.8855C-0.00621739 14.7327 0.0337409 14.5833 0.120658 14.4375L8.21441 0.4375C8.30191 0.291667 8.41507 0.182292 8.55391 0.109375C8.69274 0.0364583 8.83478 0 8.98003 0C9.12528 0 9.26762 0.0364583 9.40703 0.109375C9.54645 0.182292 9.65932 0.291667 9.74566 0.4375L17.8394 14.4375C17.9269 14.5833 17.9672 14.733 17.9602 14.8864C17.9532 15.0398 17.9129 15.1818 17.8394 15.3125C17.7659 15.4432 17.6638 15.549 17.5332 15.6301C17.4025 15.7112 17.2567 15.7512 17.0957 15.75H0.864408ZM2.37378 14H15.5863L8.98003 2.625L2.37378 14ZM8.98003 13.125C9.22795 13.125 9.43591 13.041 9.60391 12.873C9.77191 12.705 9.85562 12.4973 9.85503 12.25C9.85445 12.0027 9.77045 11.795 9.60303 11.627C9.43562 11.459 9.22795 11.375 8.98003 11.375C8.73212 11.375 8.52445 11.459 8.35703 11.627C8.18962 11.795 8.10562 12.0027 8.10503 12.25C8.10445 12.4973 8.18845 12.7053 8.35703 12.8739C8.52562 13.0425 8.73328 13.1262 8.98003 13.125ZM8.98003 10.5C9.22795 10.5 9.43591 10.416 9.60391 10.248C9.77191 10.08 9.85562 9.87233 9.85503 9.625V7C9.85503 6.75208 9.77103 6.54442 9.60303 6.377C9.43503 6.20958 9.22737 6.12558 8.98003 6.125C8.7327 6.12442 8.52503 6.20842 8.35703 6.377C8.18903 6.54558 8.10503 6.75325 8.10503 7V9.625C8.10503 9.87292 8.18903 10.0809 8.35703 10.2489C8.52503 10.4169 8.7327 10.5006 8.98003 10.5Z" fill="white"/></svg>`,
            trendIconSvg: `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.22898 9.1625C7.3496 9.04188 7.42349 8.87426 7.42325 8.69017L7.42325 8.60915C7.42325 8.24051 7.12482 7.94209 6.75665 7.94256L3.11432 7.94256L9.27572 1.78115C9.53594 1.52094 9.53594 1.09856 9.27572 0.838344C9.01551 0.578128 8.59313 0.578128 8.33291 0.838344L2.17151 6.99975V3.35741C2.17151 2.98877 1.87308 2.69034 1.50491 2.69082L1.42389 2.69082C1.05525 2.69082 0.756824 2.98924 0.757295 3.35741L0.757295 8.69017C0.757295 9.05881 1.05572 9.35724 1.42389 9.35677L6.75665 9.35677C6.94097 9.35677 7.10836 9.28312 7.22898 9.1625Z" fill="#F54351"/></svg>`
        },
        {
            title: 'Certificats expirés',
            value: '03',
            trend: '+3 ce mois',
            trendColor: 'text-[#0D823B]',
            bgColor: 'bg-gradient-to-r from-[#F5583D] to-[#F54351]',
            iconSvg: `<svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.7285 0.00248586C9.20075 -0.0307611 7.6842 0.269836 6.28468 0.883291C4.88516 1.49675 3.6364 2.40827 2.62559 3.55424C1.61477 4.7002 0.866258 6.05298 0.432307 7.51813C-0.00164418 8.98328 -0.110576 10.5255 0.113118 12.0371C0.336811 13.5487 0.887739 14.9933 1.72744 16.2699C2.56714 17.5466 3.67537 18.6246 4.97476 19.4287C6.27415 20.2328 7.73339 20.7436 9.2506 20.9254C10.7678 21.1072 12.3064 20.9557 13.759 20.4814C14.0072 20.4003 14.213 20.2239 14.3312 19.9911C14.4493 19.7582 14.4701 19.488 14.389 19.2398C14.3079 18.9916 14.1315 18.7858 13.8987 18.6677C13.6658 18.5495 13.3956 18.5287 13.1474 18.6098C11.5689 19.1252 9.87421 19.1688 8.27127 18.7351C6.66834 18.3015 5.22682 17.4094 4.12348 16.1684C3.02015 14.9274 2.30297 13.3914 2.05991 11.7487C1.81685 10.106 2.05846 8.42812 2.75513 6.92077C3.4518 5.41342 4.57323 4.14214 5.98188 3.26286C7.39054 2.38358 9.02519 1.93451 10.6854 1.97073C12.3455 2.00695 13.959 2.52688 15.328 3.46676C16.697 4.40665 17.7619 5.72562 18.3921 7.26192C18.4912 7.5035 18.6821 7.69585 18.923 7.79664C19.0422 7.84655 19.1701 7.87248 19.2994 7.87295C19.4287 7.87343 19.5568 7.84843 19.6764 7.79939C19.796 7.75036 19.9048 7.67824 19.9966 7.58716C20.0883 7.49608 20.1612 7.38782 20.2111 7.26857C20.2611 7.14931 20.287 7.02139 20.2875 6.89211C20.2879 6.76283 20.2629 6.63473 20.2139 6.51511C19.4382 4.62418 18.1276 3.00073 16.4426 1.84388C14.7577 0.687027 12.7718 0.0470656 10.7285 0.00248586ZM11.4831 4.92174C11.4831 4.66066 11.3794 4.41028 11.1948 4.22568C11.0102 4.04107 10.7598 3.93736 10.4988 3.93736C10.2377 3.93736 9.98732 4.04107 9.80271 4.22568C9.6181 4.41028 9.51439 4.66066 9.51439 4.92174V10.093L6.84477 12.7613C6.74805 12.8514 6.67048 12.9601 6.61668 13.0808C6.56288 13.2016 6.53395 13.3319 6.53162 13.4641C6.52928 13.5963 6.5536 13.7276 6.60311 13.8501C6.65262 13.9727 6.72631 14.0841 6.81978 14.1775C6.91325 14.271 7.0246 14.3447 7.14717 14.3942C7.26974 14.4437 7.40103 14.468 7.5332 14.4657C7.66538 14.4634 7.79572 14.4344 7.91647 14.3806C8.03722 14.3268 8.1459 14.2493 8.23602 14.1525L11.1944 11.1955L11.4831 10.9067V4.92174ZM19.6863 19.6874C19.6863 20.0355 19.548 20.3693 19.3018 20.6154C19.0557 20.8616 18.7219 20.9999 18.3738 20.9999C18.0257 20.9999 17.6918 20.8616 17.4457 20.6154C17.1995 20.3693 17.0613 20.0355 17.0613 19.6874C17.0613 19.3393 17.1995 19.0054 17.4457 18.7593C17.6918 18.5131 18.0257 18.3749 18.3738 18.3749C18.7219 18.3749 19.0557 18.5131 19.3018 18.7593C19.548 19.0054 19.6863 19.3393 19.6863 19.6874ZM19.3581 11.4842C19.3581 11.2232 19.2544 10.9728 19.0698 10.7882C18.8852 10.6036 18.6348 10.4999 18.3738 10.4999C18.1127 10.4999 17.8623 10.6036 17.6777 10.7882C17.4931 10.9728 17.3894 11.2232 17.3894 11.4842V16.078C17.3894 16.3391 17.4931 16.5894 17.6777 16.774C17.8623 16.9587 18.1127 17.0624 18.3738 17.0624C18.6348 17.0624 18.8852 16.9587 19.0698 16.774C19.2544 16.5894 19.3581 16.3391 19.3581 16.078V11.4842Z" fill="white"/></svg>`,
            trendIconSvg: `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.77102 0.8375C2.6504 0.95812 2.57651 1.12574 2.57675 1.30983L2.57675 1.39085C2.57675 1.75949 2.87518 2.05791 3.24335 2.05744L6.88568 2.05744L0.724278 8.21885C0.464063 8.47906 0.464063 8.90144 0.724278 9.16166C0.984494 9.42187 1.40687 9.42187 1.66709 9.16166L7.82849 3.00025V6.64259C7.82849 7.01123 8.12692 7.30966 8.49509 7.30918L8.57611 7.30918C8.94475 7.30918 9.24318 7.01076 9.24271 6.64259L9.2427 1.30983C9.2427 0.941187 8.94428 0.642759 8.57611 0.64323L3.24335 0.64323C3.05903 0.64323 2.89164 0.716879 2.77102 0.8375Z" fill="#0D823B"/></svg>`
        }
    ];

    constructor(private sanitizer: DomSanitizer) { }

    ngOnInit(): void {
        this.loadCertifications();
    }

    loadCertifications(): void {
        // TODO: Load certifications from backend
        const today = new Date();

        this.certifications = [
            {
                id: this.generateCertId(),
                nom: 'Appartement A',
                reference: 'CERT-006',
                type: 'Immobilier',
                dureeValidite: '6 mois',
                dateEmission: this.formatDate(new Date(2023, 4, 15)),
                dateExpiration: this.formatDate(new Date(2024, 4, 15)),
                score: 92,
                statut: 'Valide'
            },
            {
                id: this.generateCertId(),
                nom: 'Villa A',
                reference: 'CERT-005',
                type: 'Immobilier',
                dureeValidite: '6 mois',
                dateEmission: this.formatDate(new Date(2023, 2, 10)),
                dateExpiration: this.formatDate(new Date(2024, 2, 10)),
                score: 88,
                statut: 'Valide'
            },
            {
                id: this.generateCertId(),
                nom: 'Restaurant Le Saloum',
                reference: 'CERT-003',
                type: 'Restaurant',
                dureeValidite: '6 mois',
                dateEmission: this.formatDate(new Date(2022, 11, 5)),
                dateExpiration: this.formatDate(new Date(2023, 11, 5)),
                score: 84,
                statut: 'En renouvellement'
            },
            {
                id: this.generateCertId(),
                nom: 'Hôtel du Parc',
                reference: 'CERT-002',
                type: 'Hôtel',
                dureeValidite: '6 mois',
                dateEmission: this.formatDate(new Date(2022, 9, 20)),
                dateExpiration: this.formatDate(new Date(2023, 9, 20)),
                score: 90,
                statut: 'En renouvellement'
            },
            {
                id: this.generateCertId(),
                nom: 'Menuiserie Ndiambour',
                reference: 'CERT-001',
                type: 'Artisan',
                dureeValidite: '6 mois',
                dateEmission: this.formatDate(new Date(2022, 7, 15)),
                dateExpiration: this.formatDate(new Date(2023, 7, 15)),
                score: 78,
                statut: 'Expiré'
            }
        ];
    }

    generateCertId(): string {
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000);
        return `CERT-${timestamp.toString().slice(-6)}${random.toString().padStart(3, '0')}`;
    }

    formatDate(date: Date): string {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    openQRModal(certification: any): void {
        this.selectedCertification = certification;
        this.showQRModal = true;
    }

    closeQRModal(): void {
        this.showQRModal = false;
        this.selectedCertification = null;
    }

    downloadCertificate(): void {
        // TODO: Implement certificate download logic
        console.log('Téléchargement du certificat:', this.selectedCertification);
    }

    // Open renewal modal from "Refresh" action
    openRenewModal(cert: any): void {
        this.selectedForRenewal = cert;
        this.selectedPaymentMethod = 'carte';
        this.showRenewModal = true;
    }

    closeRenewModal(): void {
        this.showRenewModal = false;
        this.selectedForRenewal = null;
    }

    selectPaymentMethod(method: 'carte' | 'mobile'): void {
        this.selectedPaymentMethod = method;
    }

    processRenewalPayment(): void {
        // Design only: simulate payment
        console.log('Paiement renouvellement:', {
            certification: this.selectedForRenewal?.reference,
            method: this.selectedPaymentMethod
        });
        this.closeRenewModal();
    }

    getStatutClass(statut: string): string {
        switch (statut) {
            case 'Valide':
                return 'bg-[#0D823B0D] text-[#16A34A]';
            case 'En renouvellement':
                return 'bg-[#D6AB170F] text-[#D6AB17]';
            case 'Expiré':
                return 'bg-red-50 text-red-600';
            default:
                return 'bg-gray-100 text-gray-700';
        }
    }

    getIconBgClass(type: string): string {
        switch (type) {
            case 'Immobilier':
                return 'bg-[#0D823B0D]';
            case 'Restaurant':
                return 'bg-[#6F42C10F]';
            case 'Hôtel':
                return 'bg-[#FD7E140F]';
            case 'Artisan':
                return 'bg-[#0891B20F]';
            default:
                return 'bg-gray-100';
        }
    }

    getSafeHtml(html: string): SafeHtml {
        return this.sanitizer.bypassSecurityTrustHtml(html);
    }

    getTypeIconSvg(type: string): string {
        return this.typeIcons[type] || '';
    }

    shouldShowRenewButton(statut: string, isLast: boolean): boolean {
        return statut === 'En renouvellement' || isLast;
    }
}
